module bsearch

export function w $intcmp(l %a, l %b) {
start:
  %ia.1 = ld.w %a;
  %ib.1 = ld.w %b;
  %k.1 = sub.w %ia.1, %ib.1;
  ret %k.1
}

export function l $bsearch(l %key, l %base, l %nel, l %width, l %cmp) {
start:
  %nel.1 = copy.l %nel;
  %base.1 = copy.l %base;
  loop {
    if gt.l %nel.1, 0x0_l {
      %nel2.1 = udiv.l %nel.1, 0x2_l;
      %off.1 = mul.l %width, %nel2.1;
      %try.1 = add.l %base.1, %off.1;
      %sign.1 = call.w %cmp(%key, %try.1);
      if slt.w %sign.1, 0x0_w {
        %nel.2 = udiv.l %nel.1, 0x2_l;
        %nel.1 = copy.l %nel.2;
        continue
      } else {
        if sgt.w %sign.1, 0x0_w {
          %base.2 = add.l %try.1, %width;
          %ne2.1 = udiv.l %nel.1, 0x2_l;
          %ne2.2 = add.l %ne2.1, 0x1_l;
          %nel.3 = sub.l %nel.1, %ne2.2;
          %nel.1 = copy.l %nel.3;
          %base.1 = copy.l %base.2;
          continue
        } else {
          ret %try.1
        }
      }
    } else {
      ret 0x0_l
    }
  }
}
